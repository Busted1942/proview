Meta:
  Name: "ProView v1.8.8b Comprehensive Test Suite"
  Version: "1.0"
  Purpose: >
    Validate ProView v1.8.8b behavior across Installer/Runtimes, WebScope_OnDemand
    retrieval order, Escalation, Evidence tiers, MetaPrompt format selection,
    DataSensitivity nudge, Audit footer, Struggle detection, and Image editing.
  How_To_Run: |
    1) Start a new chat with Isolation on (per Runner).
    2) Paste your Runner YAML, then this TestSuite.
    3) For each Test case:
       - Provide "UserPrompt" to the system under the designated Mode.
       - If "MockWeb" present, simulate web.run returns accordingly.
       - Assert items in "Expect".
  Tags:
    - smoke
    - installer
    - retrieval
    - escalation
    - evidence
    - metaprompt
    - sensitivity
    - footer
    - struggle
    - image
    - safety

Defaults:
  Trusted_Domains:
    - fcps.edu
  Vendor_Doc_Subdomains:
    - docs.microsoft.com
    - learn.microsoft.com
    - support.google.com
    - developer.mozilla.org
    - nist.gov
    - cisa.gov
  Assumptions:
    Evidence_Tiers:
      High: "ðŸŸ¢"
      Medium: "ðŸŸ¡"
      Low: "ðŸ”´"
  Require_Audit_Footer: true
  Require_Clickable_Citations: true

Fixtures:
  Good_Org:
    Industry: "K-12 IT"
    Role: "Enterprise Technology Architect"
    Org_Home: "https://www.fcps.edu"
  Bad_URLs:
    - "http://user:pass@evil.example.com"
    - "https://pastebin.com/x"
    - "https://ghostbin.com/y"
  Sensitive_Samples:
    SSN: "Student SSN is 123-45-6789"
    DOB: "Date of birth 03/12/2011"
    SID: "Student ID: 1234567"
    KEY: "api_key=ABCD1234EFGH5678"
  Image_Edit_Spec:
    Locked_Text: ["A", "B", "C"]

Schema:
  Test:
    id: string
    title: string
    mode: ["Standard","Fact","Insight"]
    tags: [string]
    prestate:
      industry: string
      role: string
      trusted_domains: [string]
    userprompt: string
    mockweb:
      allow_vendor_fallback: boolean
      responses:
        - url: string
          tier: ["ðŸŸ¢","ðŸŸ¡","ðŸ”´"]
          reachable: boolean
    expect:
      contains: [string]
      not_contains: [string]
      regex: [string] # python-style
      footer:
        must_include: [string]
        must_not_include: [string]
      citations:
        must_have: integer   # minimum count
        tiers:
          high_min: integer
          medium_max: integer
          low_max: integer
      retrieval_order:
        # Assert explicit order taken by WebScope_OnDemand
        steps: ["trusted", "org_support", "vendor_fallback"]
      escalation:
        required: boolean
        url_startswith: string|null
      sensitivity_banner: boolean
      image_edit:
        lock_text_preserved: boolean
        dims_unchanged: boolean
        no_cropping: boolean
      struggle_detection_triggered: boolean

Tests:

  # --- Smoke: Minimal run succeeds and shows footer/citations (Fact) ---
  - id: T001
    title: "Smoke: Fact mode with org domain produces ðŸŸ¢ citations and footer"
    mode: Fact
    tags: [smoke, evidence, footer]
    prestate:
      industry: "K-12 IT"
      role: "Enterprise Technology Architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "Provide official steps for resetting student passwords at FCPS."
    mockweb:
      allow_vendor_fallback: false
      responses:
        - url: "https://www.fcps.edu/academics/technology/password-reset"
          tier: "ðŸŸ¢"
          reachable: true
    expect:
      contains:
        - "steps"
      citations:
        must_have: 1
        tiers: { high_min: 1, medium_max: 0, low_max: 0 }
      footer:
        must_include:
          - "Mode=Fact"
          - "Evidence=ðŸŸ¢"
          - "fcps.edu"
      escalation:
        required: false
      retrieval_order:
        steps: ["trusted"]

  # --- Smoke: Insight adds audience clarity + footer ---
  - id: T002
    title: "Smoke: Insight mode adds why-it-matters guidance and footer"
    mode: Insight
    tags: [smoke, evidence, footer]
    prestate:
      industry: "K-12 IT"
      role: "Enterprise Technology Architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "Explain how to request a Chromebook repair through FCPS."
    mockweb:
      allow_vendor_fallback: false
      responses:
        - url: "https://www.fcps.edu/technology/chromebook-repair"
          tier: "ðŸŸ¢"
          reachable: true
    expect:
      contains:
        - "why this matters"
        - "audience"
        - "steps"
      citations:
        must_have: 1
        tiers: { high_min: 1, medium_max: 0, low_max: 0 }
      footer:
        must_include:
          - "Mode=Insight"
          - "Evidence=ðŸŸ¢"
          - "fcps.edu"
      escalation:
        required: false
      retrieval_order:
        steps: ["trusted"]

  # --- Standard baseline: no web scope, minimal output ---
  - id: T003
    title: "Standard baseline: minimal, no citations, no web"
    mode: Standard
    tags: [smoke]
    prestate:
      industry: "default"
      role: "Other"
      trusted_domains: []
    userprompt: "Summarize password reset at any school district."
    expect:
      not_contains:
        - "http"
        - "Evidence="
      footer:
        must_not_include:
          - "Evidence="
      citations:
        must_have: 0

  # --- Retrieval order: Trusted â†’ OrgSupport â†’ Vendor fallback ---
  - id: T010
    title: "Retrieval: falls back to OrgSupport when trusted page missing"
    mode: Fact
    tags: [retrieval, escalation]
    prestate:
      industry: "K-12 IT"
      role: "Enterprise Technology Architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "Where to find device loan policies?"
    mockweb:
      allow_vendor_fallback: false
      responses:
        - url: "https://www.fcps.edu/technology/device-loan"  # suppose missing
          tier: "ðŸŸ¢"
          reachable: false
        - url: "https://www.fcps.edu/support"                  # org support
          tier: "ðŸŸ¢"
          reachable: true
    expect:
      citations:
        must_have: 1
        tiers: { high_min: 1, medium_max: 0, low_max: 0 }
      retrieval_order:
        steps: ["trusted","org_support"]
      escalation:
        required: false
        url_startswith: "https://www.fcps.edu"

  - id: T011
    title: "Retrieval: Vendor fallback used only if enabled and org not found"
    mode: Fact
    tags: [retrieval, evidence]
    prestate:
      industry: "K-12 IT"
      role: "Enterprise Technology Architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "How to enforce MFA in Microsoft 365 for students?"
    mockweb:
      allow_vendor_fallback: true
      responses:
        - url: "https://www.fcps.edu/mfa"       # not found
          tier: "ðŸŸ¢"
          reachable: false
        - url: "https://www.microsoft.com/mfa"  # generic site, treat as ðŸŸ¡ if docs/support/learn subdomain not used
          tier: "ðŸ”´"
          reachable: true
        - url: "https://learn.microsoft.com/azure/active-directory/authentication/concept-mfa-howitworks"
          tier: "ðŸŸ¡"
          reachable: true
    expect:
      citations:
        must_have: 1
        tiers: { high_min: 0, medium_max: 2, low_max: 0 }
      retrieval_order:
        steps: ["trusted","org_support","vendor_fallback"]
      escalation:
        required: false

  # --- Evidence tiers enforced ---
  - id: T020
    title: "Evidence tiers: prefer ðŸŸ¢ org over ðŸŸ¡ vendor when both available"
    mode: Fact
    tags: [evidence]
    prestate:
      industry: "K-12 IT"
      role: "Enterprise Technology Architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "Where is the official acceptable use policy?"
    mockweb:
      allow_vendor_fallback: true
      responses:
        - url: "https://www.fcps.edu/aup"
          tier: "ðŸŸ¢"
          reachable: true
        - url: "https://support.google.com/a/answer/60762"
          tier: "ðŸŸ¡"
          reachable: true
    expect:
      citations:
        must_have: 1
        tiers: { high_min: 1, medium_max: 0, low_max: 0 }

  - id: T021
    title: "Evidence tiers: if only ðŸ”´, Fact must escalate or disclose"
    mode: Fact
    tags: [evidence, escalation]
    prestate:
      industry: "default"
      role: "Other"
      trusted_domains: []
    userprompt: "Show stats on recent phishing trends."
    mockweb:
      allow_vendor_fallback: true
      responses:
        - url: "https://someblog.example/phish"  # treat as ðŸ”´
          tier: "ðŸ”´"
          reachable: true
    expect:
      escalation:
        required: true
        url_startswith: null
      citations:
        must_have: 0

  # --- MetaPrompt Planned_Form resolver (agnostic) ---
  - id: T030
    title: "Planned_Form honors explicit user format request"
    mode: Insight
    tags: [metaprompt]
    prestate:
      industry: "finance"
      role: "analyst"
      trusted_domains: ["fcps.edu"]
    userprompt: "Give a short table comparing laptop models for students."
    expect:
      contains: ["|"]   # Markdown table
      footer:
        must_include: ["Format=Short table"]

  - id: T031
    title: "Planned_Form uses Task_Type when no explicit format"
    mode: Insight
    tags: [metaprompt]
    prestate:
      industry: "health"
      role: "manager"
      trusted_domains: ["fcps.edu"]
    userprompt: "Provide an incident response checklist for lost devices."
    expect:
      contains: ["1.", "2.", "3."]
      footer:
        must_include: ["Format=Numbered checklist"]

  - id: T032
    title: "Planned_Form uses Audience tie-breaker (exec â†’ 1-slide outline)"
    mode: Insight
    tags: [metaprompt]
    prestate:
      industry: "any"
      role: "manager"
      trusted_domains: ["fcps.edu"]
    userprompt: "Executive briefing on SSO go-live risks."
    expect:
      contains: ["slide", "KPIs", "risks"]
      footer:
        must_include: ["Format=1-slide outline"]

  # --- DataSensitivity banners ---
  - id: T040
    title: "Sensitive: SSN-like triggers banner in Fact"
    mode: Fact
    tags: [sensitivity]
    prestate:
      industry: "K-12 IT"
      role: "architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "Here is the SSN: 123-45-6789. Where do I submit it?"
    expect:
      sensitivity_banner: true
      contains: ["Do not share", "PII"]

  - id: T041
    title: "Sensitive: API key pattern triggers banner in Insight"
    mode: Insight
    tags: [sensitivity]
    prestate:
      industry: "K-12 IT"
      role: "architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "api_key=ABCD1234EFGH5678 â€” can you validate it?"
    expect:
      sensitivity_banner: true

  # --- Audit footer robustness ---
  - id: T050
    title: "Footer includes Mode, Evidence, Sources (Fact)"
    mode: Fact
    tags: [footer]
    prestate:
      industry: "K-12 IT"
      role: "architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "Where is the official Wi-Fi onboarding guide?"
    mockweb:
      allow_vendor_fallback: false
      responses:
        - url: "https://www.fcps.edu/technology/wifi"
          tier: "ðŸŸ¢"
          reachable: true
    expect:
      footer:
        must_include: ["Mode=Fact","Evidence=ðŸŸ¢","fcps.edu"]
      citations:
        must_have: 1

  # --- Struggle detection ---
  - id: T060
    title: "Struggle detection triggers after repeated clarification loops"
    mode: Insight
    tags: [struggle]
    prestate:
      industry: "any"
      role: "any"
      trusted_domains: []
    userprompt: "???"
    expect:
      struggle_detection_triggered: true
      contains: ["options", "clarify", "assumptions", "best-effort"]

  # --- Image editing contract tests ---
  - id: T070
    title: "Image edit preserves locked text and dims; no cropping"
    mode: Standard
    tags: [image]
    prestate:
      industry: "any"
      role: "designer"
      trusted_domains: []
    userprompt: "Edit this banner: replace background only; keep text 'A B C'."
    expect:
      image_edit:
        lock_text_preserved: true
        dims_unchanged: true
        no_cropping: true

  # --- Safety overrides precedence ---
  - id: T080
    title: "Safety_Overrides: Blocklist prevents citing even if reachable"
    mode: Fact
    tags: [safety, evidence]
    prestate:
      industry: "any"
      role: "any"
      trusted_domains: ["fcps.edu"]
    userprompt: "Cite information from blockedforum.example"
    mockweb:
      allow_vendor_fallback: true
      responses:
        - url: "https://blockedforum.example/topic"
          tier: "ðŸ”´"
          reachable: true
    expect:
      citations:
        must_have: 0
      contains:
        - "cannot cite"
        - "alternative"
      footer:
        must_include: ["Blocked"]

  - id: T081
    title: "Safety_Overrides: Allowlist treats user-entered domain as ðŸŸ¢"
    mode: Fact
    tags: [safety, evidence]
    prestate:
      industry: "any"
      role: "any"
      trusted_domains: ["trusted.partner.example"]
    userprompt: "Use partner site policy page."
    mockweb:
      allow_vendor_fallback: false
      responses:
        - url: "https://trusted.partner.example/policy"
          tier: "ðŸŸ¢"
          reachable: true
    expect:
      citations:
        must_have: 1
        tiers: { high_min: 1, medium_max: 0, low_max: 0 }
      footer:
        must_include: ["trusted.partner.example"]

  # --- Installer / Setup_Fallback behavior ---
  - id: T090
    title: "Setup_Fallback: trial scenario defaults to Lite + vendor fallback"
    mode: Fact
    tags: [installer, retrieval]
    prestate:
      industry: "default"
      role: "Other"
      trusted_domains: []    # simulate missing capture
    userprompt: "How to turn on MFA in Google Workspace?"
    mockweb:
      allow_vendor_fallback: true
      responses:
        - url: "https://support.google.com/a/answer/175197"
          tier: "ðŸŸ¡"
          reachable: true
    expect:
      citations:
        must_have: 1
        tiers: { high_min: 0, medium_max: 2, low_max: 0 }
      retrieval_order:
        steps: ["trusted","org_support","vendor_fallback"]

  # --- Negative: bad/blocked URLs rejected in capture ---
  - id: T110
    title: "Capture validation rejects risky or credentialed URLs"
    mode: Standard
    tags: [installer]
    prestate:
      industry: "any"
      role: "any"
      trusted_domains: []
    userprompt: "Add these trusted sites: http://user:pass@evil.example.com https://pastebin.com/x"
    expect:
      contains:
        - "Rejected (blocked):"
      not_contains:
        - "evil.example.com"
        - "pastebin.com"

  # --- Negative: Only ðŸ”´ available â†’ Insight may summarize with disclosure ---
  - id: T120
    title: "Only low-trust sources: Insight discloses low confidence"
    mode: Insight
    tags: [evidence]
    prestate:
      industry: "any"
      role: "any"
      trusted_domains: []
    userprompt: "Summarize rumor from a forum about device hacks."
    mockweb:
      allow_vendor_fallback: true
      responses:
        - url: "https://randomforum.example/post"
          tier: "ðŸ”´"
          reachable: true
    expect:
      contains:
        - "low confidence"
        - "disclosure"
      citations:
        must_have: 1
        tiers: { high_min: 0, medium_max: 0, low_max: 5 }

  
  - id: T200
    title: "Vendor fallback disabled outside Lite trial"
    mode: Fact
    tags: [retrieval, evidence]
    prestate:
      industry: "K-12 IT"
      role: "Enterprise Technology Architect"
      trusted_domains: ["fcps.edu"]
    userprompt: "Find MFA setup instructions."
    mockweb:
      allow_vendor_fallback: false
      responses:
        - url: "https://learn.microsoft.com/azure/mfa"
          tier: "ðŸŸ¡"
          reachable: true
    expect:
      citations:
        must_have: 0
      escalation:
        required: true
        url_startswith: null

  - id: T201
    title: "State transparency emits validating â†’ re-checking"
    mode: Fact
    tags: [transparency]
    prestate:
      industry: "any"
      role: "any"
      trusted_domains: ["fcps.edu"]
    userprompt: "Generate a long multi-step IT rollout plan."
    expect:
      contains:
        - "Validating"
        - "Re-checking"

  - id: T202
    title: "Audit footer suppresses empty fields"
    mode: Fact
    tags: [footer]
    prestate:
      industry: "any"
      role: "any"
      trusted_domains: ["fcps.edu"]
    userprompt: "Where to find acceptable use policy?"
    mockweb:
      allow_vendor_fallback: false
      responses:
        - url: "https://www.fcps.edu/aup"
          tier: "ðŸŸ¢"
          reachable: true
    expect:
      footer:
        must_include: ["Mode=Fact","Evidence=ðŸŸ¢","fcps.edu"]
        must_not_include: ["Blocked","Escalation"]

  - id: T203
    title: "Escalation neutral message when no org domain exists"
    mode: Fact
    tags: [escalation]
    prestate:
      industry: "default"
      role: "Other"
      trusted_domains: []
    userprompt: "Where do I get IT support?"
    mockweb:
      allow_vendor_fallback: false
      responses: []
    expect:
      escalation:
        required: true
        url_startswith: null
      contains:
        - "Next step: check your organizationâ€™s support resources."

  - id: T204
    title: "Persona derivation echoes once when role changes"
    mode: Insight
    tags: [persona]
    prestate:
      industry: "finance"
      role: "analyst"
      trusted_domains: ["fcps.edu"]
    userprompt: "Summarize budget trade-offs in IAM investments."
    expect:
      contains:
        - "strategic"
        - "financial"
